<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AI Chat</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Inter', 'Segoe UI', sans-serif;
  background-color: #f7f7f8;
  color: #333;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
#sidebar {
  width: 260px;
  background: #202123;
  color: white;
  display: flex;
  flex-direction: column;
  padding: 12px;
}
#sidebar h2 { margin: 10px 0 20px 10px; font-size: 18px; font-weight: 600; }
.sidebar-btn {
  padding: 10px 14px;
  margin: 5px 0;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #343541;
  color: #fff;
  text-align: left;
  font-size: 14px;
  transition: background 0.2s;
}
.sidebar-btn:hover { background: #444654; }
#history-list { flex: 1; overflow-y: auto; margin-top: 10px; }
.history-item {
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}
.history-item:hover { background: #343541; }
.history-item.active { background: #0b93f6; }
#clear-all { background: #f44336; margin-top: 10px; }

#main { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }
#chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
.msg { margin: 10px 0; padding: 12px 16px; border-radius: 12px; max-width: 80%; line-height: 1.6; word-wrap: break-word; animation: fadeIn 0.2s ease; }
.user { background: #DCF8C6; align-self: flex-end; }
.ai { background: #fff; border: 1px solid #eee; align-self: flex-start; }
#input-container { display: flex; padding: 12px 20px; border-top: 1px solid #ddd; background: #fff; }
#input { flex: 1; resize: none; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; max-height: 200px; }
#send { margin-left: 10px; background-color: #0b93f6; color: white; border: none; border-radius: 8px; padding: 0 20px; cursor: pointer; }
#send:disabled { background-color: #8fbce6; cursor: not-allowed; }

code { background: #eee; padding: 2px 4px; border-radius: 4px; }
pre { background: #282c34; color: #f8f8f2; padding: 12px; border-radius: 8px; overflow-x: auto; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* 移动端按钮 */
#mobile-history-btn, #mobile-new-session-btn {
  display: none;
  position: fixed;
  top: 12px;
  background: #0b93f6;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  z-index: 1000;
  cursor: pointer;
}
#mobile-history-btn { left: 12px; }
#mobile-new-session-btn { right: 12px; }

#mobile-history-drawer {
  position: fixed;
  top: 0; left: 0;
  width: 80%;
  max-width: 300px;
  height: 100%;
  background: #202123;
  color: white;
  overflow-y: auto;
  padding: 12px;
  z-index: 1001;
  flex-direction: column;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
}
#mobile-history-drawer.show { transform: translateX(0); }
#mobile-history-drawer button { margin-bottom: 8px; }

@media (max-width: 900px){
  #sidebar { display: none; }
  #mobile-history-btn, #mobile-new-session-btn { display: block; }
}
</style>
</head>
<body>

<div id="sidebar">
  <h2>💬 AI Chat</h2>
  <button class="sidebar-btn" id="new-session">➕ 新建会话</button>
  <div id="history-list"></div>
  <button class="sidebar-btn" id="clear-all">❌ 清空所有记录</button>
</div>

<div id="main">
  <div id="chat-container"></div>
  <div id="input-container">
    <textarea id="input" rows="2" placeholder="输入你的问题..."></textarea>
    <button id="send">发送</button>
  </div>
</div>

<!-- 移动端按钮 -->
<button id="mobile-history-btn">📜 历史</button>
<button id="mobile-new-session-btn">➕ 新建会话</button>

<!-- 移动端历史记录抽屉 -->
<div id="mobile-history-drawer">
  <button id="mobile-close-drawer">关闭</button>
  <div id="mobile-history-list"></div>
  <button class="sidebar-btn" id="mobile-clear-all">❌ 清空所有记录</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const chatContainer=document.getElementById("chat-container");
const input=document.getElementById("input");
const sendBtn=document.getElementById("send");
const newSessionBtn=document.getElementById("new-session");
const clearAllBtn=document.getElementById("clear-all");
const historyList=document.getElementById("history-list");

// 移动端
const mobileBtn=document.getElementById("mobile-history-btn");
const mobileNewBtn=document.getElementById("mobile-new-session-btn");
const mobileDrawer=document.getElementById("mobile-history-drawer");
const mobileClose=document.getElementById("mobile-close-drawer");
const mobileHistoryList=document.getElementById("mobile-history-list");
const mobileClearAll=document.getElementById("mobile-clear-all");

let sessions=JSON.parse(localStorage.getItem("ai_sessions")||"{}");
let currentSession=localStorage.getItem("ai_current")||Object.keys(sessions)[0]||"default";
if(!sessions[currentSession]) sessions[currentSession]=[];

function save(){ localStorage.setItem("ai_sessions", JSON.stringify(sessions)); localStorage.setItem("ai_current", currentSession); }

function renderHistory(){
  historyList.innerHTML="";
  const keys=Object.keys(sessions).filter(k=>sessions[k].some(m=>m.content && m.content.trim()!=="")).slice(-100);
  for(const k of keys){
    const firstMsg=sessions[k].find(m=>m.role==='user')?.content?.slice(0,12)||"新会话";
    const div=document.createElement("div");
    div.className="history-item"+(k===currentSession?" active":"");
    div.textContent=firstMsg;
    div.onclick=()=>{ currentSession=k; renderHistory(); renderChat(); renderMobileHistory(); save(); };
    historyList.appendChild(div);
  }
}

function renderMobileHistory(){
  mobileHistoryList.innerHTML="";
  const keys=Object.keys(sessions).filter(k=>sessions[k].some(m=>m.content && m.content.trim()!=="")).slice(-100);
  for(const k of keys){
    const firstMsg=sessions[k].find(m=>m.role==='user')?.content?.slice(0,12)||"新会话";
    const div=document.createElement("div");
    div.className="history-item"+(k===currentSession?" active":"");
    div.textContent=firstMsg;
    div.onclick=()=>{ currentSession=k; renderChat(); mobileDrawer.classList.remove("show"); renderHistory(); save(); };
    mobileHistoryList.appendChild(div);
  }
}

function renderChat(){
  chatContainer.innerHTML="";
  const msgs=sessions[currentSession]||[];
  for(const m of msgs) if(m.content && m.content.trim()!=="") addMsg(m.role,m.content,false);
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

function addMsg(role,content,saveMsg=true){
  if(!content || content.trim()==="") return;
  const div=document.createElement("div");
  div.className="msg "+role;
  div.innerHTML=marked.parse(content);
  chatContainer.appendChild(div);
  if(saveMsg){
    if(!sessions[currentSession]) sessions[currentSession]=[];
    sessions[currentSession].push({role, content});
    save();
  }
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

async function sendMsg(){
  const text=input.value.trim();
  if(!text) return;
  input.value="";
  addMsg("user",text);
  sendBtn.disabled=true;

  const aiDiv=document.createElement("div");
  aiDiv.className="msg ai";
  chatContainer.appendChild(aiDiv);
  chatContainer.scrollTop=chatContainer.scrollHeight;

  sessions[currentSession].push({role:"assistant",content:""});
  const idx=sessions[currentSession].length-1;
  save();

  try{
    const res=await fetch("/api/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:sessions[currentSession]})
    });

    if(!res.ok){
      const errText=await res.text();
      addMsg("ai","⚠️ API错误: "+errText);
      sendBtn.disabled=false;
      return;
    }

    const reader=res.body.getReader();
    const decoder=new TextDecoder();
    let fullText="";
    while(true){
      const { value, done } = await reader.read();
      if(done) break;
      const chunk=decoder.decode(value,{stream:true});
      fullText+=chunk;
      if(fullText.trim()!==""){
        aiDiv.innerHTML=marked.parse(fullText);
        sessions[currentSession][idx].content=fullText;
        save();
      }
      chatContainer.scrollTop=chatContainer.scrollHeight;
    }
  }catch(e){
    addMsg("ai","⚠️ 网络或API错误: "+e.message);
  } finally{
    sendBtn.disabled=false;
  }
}

// 桌面事件
sendBtn.onclick=sendMsg;
input.addEventListener("keydown", e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMsg(); } });
newSessionBtn.onclick=()=>{ const name="session-"+Date.now(); currentSession=name; sessions[currentSession]=[]; renderHistory(); renderChat(); renderMobileHistory(); save(); };
clearAllBtn.onclick=()=>{ if(confirm("确定清空所有记录？")){ sessions={}; currentSession="default"; sessions[currentSession]=[]; renderChat(); renderHistory(); renderMobileHistory(); save(); } };

// 移动端事件
mobileBtn.onclick = () => { renderMobileHistory(); mobileDrawer.classList.add("show"); };
mobileClose.onclick = () => mobileDrawer.classList.remove("show");
mobileNewBtn.onclick = () => { const name="session-"+Date.now(); sessions[name]=[]; currentSession=name; renderChat(); renderHistory(); renderMobileHistory(); save(); };
mobileClearAll.onclick = () => { if(confirm("确定清空所有记录？")){ sessions={}; currentSession="default"; sessions[currentSession]=[]; renderChat(); renderHistory(); renderMobileHistory(); save(); } };

renderHistory(); renderChat();
</script>
</body>
</html>
