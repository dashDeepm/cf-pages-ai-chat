<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AI Chat</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, sans-serif;
  background-color: #f7f7f8;
  color: #333;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* å·¦ä¾§ä¾§è¾¹æ  */
#sidebar {
  width: 260px;
  background: #202123;
  color: white;
  display: flex;
  flex-direction: column;
  padding: 10px;
}
#sidebar h2 {
  margin: 10px 0 20px 10px;
  font-size: 18px;
}
.sidebar-btn {
  padding: 8px 12px;
  margin: 5px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #343541;
  color: #fff;
  text-align: left;
}
.sidebar-btn:hover { background: #444654; }
#history-list {
  flex: 1;
  overflow-y: auto;
  margin-top: 10px;
}
.history-item {
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}
.history-item:hover { background: #343541; }
.history-item.active { background: #0b93f6; }
#clear-all {
  background: #f44336;
  margin-top: 10px;
}

/* èŠå¤©åŒº */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
}
#chat-container {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.msg {
  margin: 10px 0;
  padding: 12px 16px;
  border-radius: 12px;
  max-width: 80%;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.user { background: #DCF8C6; align-self: flex-end; }
.ai {
  background: #fff;
  border: 1px solid #eee;
  align-self: flex-start;
}

/* è¾“å…¥æ¡† */
#input-container {
  display: flex;
  padding: 12px 20px;
  border-top: 1px solid #ddd;
  background: #fff;
}
#input {
  flex: 1;
  resize: none;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
}
#send {
  margin-left: 10px;
  background-color: #0b93f6;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0 20px;
  cursor: pointer;
}

/* markdown */
code { background: #eee; padding: 2px 4px; border-radius: 4px; }
pre {
  background: #282c34;
  color: #f8f8f2;
  padding: 10px;
  border-radius: 8px;
  overflow-x: auto;
}
@media (max-width: 800px) {
  #sidebar { width: 200px; }
}
</style>
</head>
<body>

<div id="sidebar">
  <h2>ğŸ’¬ AI Chat</h2>
  <button class="sidebar-btn" id="new-session">â• æ–°å»ºä¼šè¯</button>
  <button class="sidebar-btn" id="clear-session">ğŸ§¹ æ¸…ç©ºå½“å‰</button>
  <div id="history-list"></div>
  <button class="sidebar-btn" id="clear-all">âŒ æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
</div>

<div id="main">
  <div id="chat-container"></div>
  <div id="input-container">
    <textarea id="input" rows="2" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."></textarea>
    <button id="send">å‘é€</button>
  </div>
</div>

<!-- markdown + é«˜äº® -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js/lib/common.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github-dark.min.css">

<script>
const chatContainer = document.getElementById("chat-container");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const newSessionBtn = document.getElementById("new-session");
const clearSessionBtn = document.getElementById("clear-session");
const clearAllBtn = document.getElementById("clear-all");
const historyList = document.getElementById("history-list");

let sessions = JSON.parse(localStorage.getItem("ai_sessions")||"{}");
let currentSession = localStorage.getItem("ai_current") || Object.keys(sessions)[0] || "default";
if(!sessions[currentSession]) sessions[currentSession] = [];

function saveSessions(){
  localStorage.setItem("ai_sessions", JSON.stringify(sessions));
  localStorage.setItem("ai_current", currentSession);
}

function renderHistory(){
  historyList.innerHTML = "";
  const keys = Object.keys(sessions).slice(-100);
  for(const k of keys){
    const div = document.createElement("div");
    div.className = "history-item"+(k===currentSession?" active":"");
    const firstMsg = (sessions[k].find(m=>m.role==='user')?.content||"").slice(0,10) || "æ–°ä¼šè¯";
    div.textContent = firstMsg;
    div.onclick = ()=>{
      currentSession = k;
      renderHistory();
      renderChat();
      saveSessions();
    };
    historyList.appendChild(div);
  }
}

function renderChat(){
  chatContainer.innerHTML = "";
  const msgs = sessions[currentSession]||[];
  for(const m of msgs) addMsg(m.role, m.content, false);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addMsg(role, content, save=true){
  const div = document.createElement("div");
  div.className = "msg "+role;
  div.innerHTML = marked.parse(content);
  chatContainer.appendChild(div);
  if(save){
    sessions[currentSession].push({role,content});
    saveSessions();
  }
  chatContainer.scrollTop = chatContainer.scrollHeight;
  hljs.highlightAll();
}

async function sendMsg(){
  const text = input.value.trim();
  if(!text) return;
  input.value="";
  addMsg("user", text);

  const aiDiv = document.createElement("div");
  aiDiv.className = "msg ai";
  chatContainer.appendChild(aiDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  sessions[currentSession].push({role:"assistant",content:""});
  const idx = sessions[currentSession].length-1;
  saveSessions();

  const payload = {
    messages: sessions[currentSession].map(m=>({role:m.role,content:m.content}))
  };

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    while(true){
      const {value,done} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      aiDiv.innerHTML += marked.parseInline(chunk);
      sessions[currentSession][idx].content += chunk;
      saveSessions();
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    hljs.highlightAll();
  } catch(err){
    aiDiv.innerHTML = "<i>å‡ºé”™äº†ï¼Œè¯·ç¨åå†è¯•ã€‚</i>";
  }
}

// äº‹ä»¶
sendBtn.onclick = sendMsg;
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});
newSessionBtn.onclick = ()=>{
  const name="session-"+Date.now();
  sessions[name]=[];
  currentSession=name;
  renderHistory(); renderChat(); saveSessions();
};
clearSessionBtn.onclick=()=>{
  sessions[currentSession]=[];
  renderChat(); saveSessions();
};
clearAllBtn.onclick=()=>{
  if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ")){
    sessions={};
    currentSession="default";
    sessions[currentSession]=[];
    renderHistory(); renderChat(); saveSessions();
  }
};

// åˆå§‹åŒ–
renderHistory();
renderChat();
</script>
</body>
</html>
