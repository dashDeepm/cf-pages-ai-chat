<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background-color: #f9fafb; }
    .chat-container { max-width: 800px; margin: auto; padding: 1rem; }
    .message { border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; white-space: pre-wrap; }
    .user { background-color: #dbeafe; text-align: right; }
    .assistant { background-color: #f3f4f6; }
    .chat-box { height: 60vh; overflow-y: auto; margin-bottom: 1rem; }
    .history-item:hover { background-color: #f9fafb; cursor: pointer; }
  </style>
</head>
<body>
  <div class="chat-container">
    <h1 class="text-2xl font-bold text-center mb-4">ğŸ’¬ AI Chat</h1>

    <div class="flex justify-between mb-4">
      <button id="newChat" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">æ–°å»ºå¯¹è¯</button>
      <button id="showHistory" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">æŸ¥çœ‹å†å²</button>
    </div>

    <div id="chatBox" class="chat-box border border-gray-300 rounded-lg bg-white p-4"></div>

    <div class="flex">
      <textarea id="userInput" class="flex-1 border border-gray-300 rounded-lg p-2 resize-none" rows="2" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."></textarea>
      <button id="sendBtn" class="bg-blue-500 text-white px-4 py-2 ml-2 rounded-lg hover:bg-blue-600">å‘é€</button>
    </div>
  </div>

  <!-- å†å²è®°å½•å¼¹çª— -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg w-11/12 md:w-2/3 p-4 max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
        å†å²è®°å½•
        <button id="clearHistory" class="text-red-500 hover:underline text-sm">æ¸…ç©ºæ‰€æœ‰</button>
      </h2>
      <ul id="historyList" class="divide-y divide-gray-200"></ul>
      <div class="mt-4 text-right">
        <button id="closeHistory" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const newChatBtn = document.getElementById("newChat");
    const historyBtn = document.getElementById("showHistory");
    const historyModal = document.getElementById("historyModal");
    const closeHistory = document.getElementById("closeHistory");
    const clearHistory = document.getElementById("clearHistory");
    const historyList = document.getElementById("historyList");

    let messages = [];
    let history = JSON.parse(localStorage.getItem("chat_history") || "[]");

    function saveHistory() {
      if (messages.length === 0) return;
      const title = messages[0]?.content?.slice(0, 10) || "æ— æ ‡é¢˜";
      history.unshift({ title, messages });
      if (history.length > 100) history.pop();
      localStorage.setItem("chat_history", JSON.stringify(history));
    }

    function renderMessages() {
      chatBox.innerHTML = "";
      messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = `message ${msg.role}`;
        if (msg.role === "assistant") {
          div.innerHTML = marked.parse(msg.content);
        } else {
          div.textContent = msg.content;
        }
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const content = userInput.value.trim();
      if (!content) return;

      messages.push({ role: "user", content });
      renderMessages();
      userInput.value = "";

      const div = document.createElement("div");
      div.className = "message assistant";
      chatBox.appendChild(div);

      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let assistantMsg = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value);
        assistantMsg += chunk;
        div.innerHTML = marked.parse(assistantMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      messages.push({ role: "assistant", content: assistantMsg });
      saveHistory();
    }

    function showHistoryModal() {
      historyList.innerHTML = "";
      if (history.length === 0) {
        historyList.innerHTML = "<li class='text-gray-500 text-center py-4'>æš‚æ— å†å²è®°å½•</li>";
      } else {
        history.forEach((h, i) => {
          const li = document.createElement("li");
          li.className = "p-2 history-item";
          li.textContent = `${i + 1}. ${h.title}`;
          li.onclick = () => {
            messages = h.messages;
            renderMessages();
            historyModal.classList.add("hidden");
          };
          historyList.appendChild(li);
        });
      }
      historyModal.classList.remove("hidden");
    }

    sendBtn.onclick = sendMessage;
    newChatBtn.onclick = () => { messages = []; renderMessages(); };
    historyBtn.onclick = showHistoryModal;
    closeHistory.onclick = () => historyModal.classList.add("hidden");
    clearHistory.onclick = () => {
      localStorage.removeItem("chat_history");
      history = [];
      showHistoryModal();
    };
  </script>
</body>
</html>
