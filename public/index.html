<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>AI Chat</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: #f7f7f8;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background-color: #202123;
  color: white;
  padding: 12px 20px;
  font-size: 20px;
}
#sessions {
  display: flex;
  padding: 10px 20px;
  gap: 10px;
  background: #f1f1f1;
  flex-wrap: wrap;
}
.session-btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
  background: white;
}
.session-btn.active { border-color: #0b93f6; }
#chat-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}
.msg {
  margin: 10px 0;
  padding: 12px;
  border-radius: 12px;
  max-width: 80%;
  word-wrap: break-word;
  white-space: pre-wrap;
}
.user { background: #DCF8C6; align-self: flex-end; }
.ai { background: #fff; border: 1px solid #eee; align-self: flex-start; }
#input-container {
  display: flex;
  padding: 10px 20px;
  background: #fff;
  border-top: 1px solid #ccc;
}
#input-container textarea {
  flex: 1;
  resize: none;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
}
#input-container button {
  margin-left: 10px;
  padding: 10px 20px;
  border: none;
  background-color: #0b93f6;
  color: white;
  border-radius: 8px;
  cursor: pointer;
}

/* 历史记录弹窗样式 */
#history-modal {
  position: fixed;
  top: 0; left: 0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}
#history-content {
  background: #fff;
  max-height: 80%;
  width: 80%;
  overflow-y: auto;
  padding: 20px;
  border-radius: 10px;
}
.history-item {
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
  padding-bottom: 10px;
}
</style>
</head>
<body>

<header>AI Chat</header>

<div id="sessions">
  <button id="new-session" class="session-btn">新建会话</button>
  <button id="clear-session" class="session-btn">清空当前</button>
  <button id="view-history" class="session-btn">查看历史记录</button>
</div>

<div id="chat-container"></div>

<div id="input-container">
  <textarea id="input" rows="2" placeholder="输入你的问题..."></textarea>
  <button id="send">发送</button>
</div>

<!-- 历史记录弹窗 -->
<div id="history-modal">
  <div id="history-content"></div>
</div>

<!-- Markdown解析库 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const chatContainer = document.getElementById("chat-container");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const newSessionBtn = document.getElementById("new-session");
const clearSessionBtn = document.getElementById("clear-session");
const viewHistoryBtn = document.getElementById("view-history");
const historyModal = document.getElementById("history-modal");
const historyContent = document.getElementById("history-content");

let sessions = JSON.parse(localStorage.getItem("ai_sessions")||"{}");
let currentSession = Object.keys(sessions)[0] || "default";
if(!sessions[currentSession]) sessions[currentSession]=[];

function renderSession() {
  chatContainer.innerHTML = "";
  const msgs = sessions[currentSession]||[];
  for(const m of msgs){
    addMessageDiv(m.role, m.content, false);
  }
  scrollBottom();
}

function addMessageDiv(role, content, save=true){
  const div = document.createElement("div");
  div.className = "msg "+role;
  div.innerHTML = marked.parse(content);
  chatContainer.appendChild(div);
  if(save){
    sessions[currentSession] = sessions[currentSession]||[];
    sessions[currentSession].push({role, content});
    localStorage.setItem("ai_sessions", JSON.stringify(sessions));
  }
  scrollBottom();
}

function scrollBottom(){
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function sendMessage(){
  const msg = input.value.trim();
  if(!msg) return;
  input.value="";
  addMessageDiv("user", msg);

  const messages = sessions[currentSession].map(m=>({role:m.role,content:m.content}));
  fetch("/api/chat",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "User-Agent":navigator.userAgent
    },
    body:JSON.stringify({messages})
  }).then(res=>{
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let aiDiv = document.createElement("div");
    aiDiv.className = "msg ai";
    chatContainer.appendChild(aiDiv);
    sessions[currentSession].push({role:"assistant", content:""});
    const msgIndex = sessions[currentSession].length-1;

    function read(){
      reader.read().then(({value,done})=>{
        if(done) return;
        const text = decoder.decode(value);
        aiDiv.innerHTML += marked.parseInline(text);
        sessions[currentSession][msgIndex].content += text;
        localStorage.setItem("ai_sessions", JSON.stringify(sessions));
        scrollBottom();
        read();
      })
    }
    read();
  })
}

// 会话按钮事件
newSessionBtn.onclick = ()=>{
  let name = "session-"+Date.now();
  sessions[name] = [];
  currentSession = name;
  renderSession();
}

clearSessionBtn.onclick = ()=>{
  sessions[currentSession]=[];
  localStorage.setItem("ai_sessions", JSON.stringify(sessions));
  renderSession();
}

// 查看历史记录按钮
viewHistoryBtn.onclick = ()=>{
  historyContent.innerHTML = "";
  const keys = Object.keys(sessions).reverse().slice(0,100); // 最新100条会话
  keys.forEach(key=>{
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `<strong>${key}</strong><br>` + sessions[key].map(m=>`<em>${m.role}:</em> ${marked.parseInline(m.content)}`).join("<br>");
    historyContent.appendChild(div);
  });
  historyModal.style.display = "flex";
}

// 点击弹窗关闭
historyModal.onclick = (e)=>{
  if(e.target===historyModal) historyModal.style.display = "none";
}

// 初始化渲染
renderSession();

sendBtn.onclick = sendMessage;
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey) { e.preventDefault(); sendMessage();}
});
</script>

</body>
</html>
